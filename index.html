function doGet(e) {
  const code = e.parameter.code;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const rows = sheet.getDataRange().getValues();
  
  for (let i = 1; i < rows.length; i++) {
    // Сравниваем код (приводим к строке)
    if (rows[i][0].toString() == code) {
      
      // ЗАЩИТА ОТ ПОВТОРНОГО ВХОДА
      // Если статус не пустой (значит там STARTED или FINISHED), то блокируем
      if (rows[i][1] !== '') {
        return responseJSON({ 
          success: false, 
          message: 'Этот код уже был активирован. Повторный вход запрещен правилами безопасности.' 
        });
      }

      // Если чисто - пускаем и ставим метку STARTED
      sheet.getRange(i + 1, 2).setValue('STARTED'); // Статус
      sheet.getRange(i + 1, 7).setValue(new Date()); // Дата (Col G)
      
      return responseJSON({ success: true, message: 'OK' });
    }
  }
  
  // Если код не найден в таблице
  return responseJSON({ success: false, message: 'Неверный код доступа.' });
}

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const data = JSON.parse(e.postData.contents);
    const code = data.code.toString();
    const rows = sheet.getDataRange().getValues();
    
    let rowIndex = -1;
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0].toString() == code) {
        rowIndex = i + 1;
        break;
      }
    }

    if (rowIndex === -1) return responseJSON({ success: false, error: 'User not found' });

    // 1. UPDATE: Фоновое сохранение (Колонки H и I)
    if (data.action === 'update_progress') {
      sheet.getRange(rowIndex, 8).setValue(data.lastQuestion); 
      sheet.getRange(rowIndex, 9).setValue(data.wrongTopics);
      return responseJSON({ success: true });
    }

    // 2. SAVE LEVEL: Сохранение баллов за уровень
    if (data.action === 'save_level') {
      const level = parseInt(data.level);
      // Col 3=Lv1, 4=Lv2, 5=Lv3, 6=Lv4
      sheet.getRange(rowIndex, 2 + level).setValue(data.score);
      return responseJSON({ success: true });
    }

    // 3. FINISH: Финал
    if (data.action === 'finish_test') {
      sheet.getRange(rowIndex, 2).setValue('FINISHED');
      sheet.getRange(rowIndex, 9).setValue(data.wrongTopics);
      return responseJSON({ success: true });
    }
    
  } catch (err) {
    return responseJSON({ success: false, error: err.toString() });
  }
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
