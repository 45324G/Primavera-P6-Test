<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primavera P6 Certification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Стили для печати */
        @media print {
            body * { visibility: hidden; }
            #screen-final, #screen-final * { visibility: visible; }
            #screen-final { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; max-width: 100%; transform: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU17rCYuqwhRvxvunLRkvVUtmV1Qii74MuSLcQyAy2xPUgPjoY9rGC-zwST7RLcC5o/exec"; 
    </script>

    <div id="screen-login" class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl text-center fade-in">
        <h2 class="text-2xl font-bold mb-2 text-slate-900">Primavera Expert</h2>
        <p class="text-slate-500 mb-6 text-sm">Введите код доступа</p>
        <input type="tel" id="access-code" maxlength="6" placeholder="• • • • • •" class="w-full text-center text-3xl font-bold py-3 border-2 border-slate-200 rounded-xl mb-4">
        <p id="login-error" class="text-red-500 text-xs mb-4 hidden"></p>
        <button onclick="attemptLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all">Войти</button>
    </div>

    <div id="screen-quiz" class="hidden w-full max-w-3xl flex flex-col min-h-screen">
        <header class="bg-white border-b p-4 sticky top-0 z-20 flex justify-between">
            <span class="font-bold">Вопрос <span id="ui-q-num">1</span></span>
            <span class="font-mono bg-slate-100 px-2 rounded" id="ui-timer">15:00</span>
        </header>
        <main class="flex-grow flex flex-col items-center p-4">
            <div class="w-full max-w-2xl bg-white rounded-2xl shadow p-6">
                <h3 id="question-text" class="text-xl font-bold mb-6">...</h3>
                <div id="options-list" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <div id="modal-error" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white p-6 rounded-2xl max-w-md w-full text-center fade-in">
            <div class="text-red-500 text-4xl mb-2"><i class="fa-solid fa-circle-xmark"></i></div>
            <h3 class="text-lg font-bold text-slate-800">Ошибка</h3>
            <p id="modal-error-text" class="text-slate-600 my-4 text-sm text-left bg-slate-50 p-3 rounded"></p>
            <button onclick="closeErrorModal()" class="bg-slate-800 text-white px-6 py-2 rounded-lg w-full">Понятно, дальше</button>
        </div>
    </div>

    <div id="screen-final" class="hidden w-full max-w-2xl bg-white p-10 rounded-3xl shadow-xl text-center fade-in">
        <div class="mb-4 text-green-500 text-5xl no-print"><i class="fa-solid fa-circle-check"></i></div>
        <h2 class="text-3xl font-bold mb-2 text-slate-900">Отчет о тестировании</h2>
        <p class="text-slate-500 mb-6">Primavera P6 Assessment</p>
        
        <div class="grid grid-cols-2 gap-4 text-left mb-6 border-b pb-6">
            <div><span class="text-xs text-slate-400">Сотрудник (ID):</span><div class="font-mono font-bold" id="final-code"></div></div>
            <div><span class="text-xs text-slate-400">Дата:</span><div class="font-bold" id="final-date"></div></div>
            <div><span class="text-xs text-slate-400">Результат:</span><div class="font-bold text-blue-600" id="final-score"></div></div>
        </div>

        <div id="recommendation-block" class="text-left hidden">
            <h3 class="text-sm font-bold text-slate-800 mb-3 uppercase">Темы для изучения:</h3>
            <ul id="topic-list" class="space-y-2 text-sm text-slate-600 border p-4 rounded-lg bg-slate-50"></ul>
        </div>
        
        <div class="mt-8 flex gap-3 no-print">
            <button onclick="window.print()" class="flex-1 bg-slate-800 text-white py-3 rounded-xl"><i class="fa-solid fa-print mr-2"></i> Распечатать / PDF</button>
            <button onclick="location.reload()" class="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl">Закрыть</button>
        </div>
    </div>

    <script src="questions.js"></script>
    <script>
        // CONFIG
        const LEVELS = [25, 50, 75, 100]; // Границы блоков (25, 26-50, etc)
        
        // STATE
        let currentQIndex = 0;
        let score = 0;
        let userCode = "";
        let wrongTopics = []; 
        let isPaused = false;

        // LOGIN
        async function attemptLogin() {
            const btn = document.getElementById('btn-login');
            userCode = document.getElementById('access-code').value.trim();
            if (userCode.length < 6) return alert("Код должен быть 6 цифр");
            
            btn.disabled = true; btn.innerText = "Загрузка...";
            try {
                // Вызов API (Login)
                const res = await fetch(`${API_URL}?code=${userCode}`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('screen-login').classList.add('hidden');
                    document.getElementById('screen-quiz').classList.remove('hidden');
                    loadQuestion();
                } else {
                    alert(data.message); btn.disabled = false; btn.innerText = "Войти";
                }
            } catch (e) { console.error(e); alert("Ошибка сети"); btn.disabled = false; }
        }

        // LOAD QUESTION
        function loadQuestion() {
            if (currentQIndex >= quizData.length) { finishTest(); return; }
            
            const qData = quizData[currentQIndex];
            document.getElementById('ui-q-num').innerText = qData.id; // Используем ID из JSON (1-100)
            document.getElementById('question-text').innerText = qData.q;
            
            const list = document.getElementById('options-list');
            list.innerHTML = '';

            // Shuffle
            let opts = qData.opt.map((txt, i) => ({ txt, isCorrect: i === qData.c }));
            opts.sort(() => Math.random() - 0.5);

            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 border rounded-xl hover:bg-blue-50 transition-all";
                btn.innerText = o.txt;
                btn.onclick = () => handleAnswer(o.isCorrect, qData);
                list.appendChild(btn);
            });
        }

        // HANDLE ANSWER
        function handleAnswer(isCorrect, qData) {
            if (isPaused) return;
            
            if (isCorrect) {
                score++;
                nextStep();
            } else {
                // Ошибка -> Показываем модалку с пояснением
                isPaused = true;
                wrongTopics.push(qData.t || "Общее");
                document.getElementById('modal-error-text').innerText = qData.exp;
                document.getElementById('modal-error').classList.remove('hidden');
                
                // Фоновое сохранение прогресса (чтобы знать, на чем ошибся, если закроет)
                sendProgress(currentQIndex + 1, JSON.stringify(wrongTopics));
            }
        }

        function closeErrorModal() {
            document.getElementById('modal-error').classList.add('hidden');
            isPaused = false;
            nextStep();
        }

        function nextStep() {
            currentQIndex++;
            loadQuestion();
        }

        async function sendProgress(lastQ, topicsJson) {
            try {
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ action: 'update_progress', code: userCode, lastQuestion: lastQ, wrongTopics: topicsJson })
                });
            } catch(e) {}
        }

        async function finishTest() {
            document.getElementById('screen-quiz').classList.add('hidden');
            document.getElementById('screen-final').classList.remove('hidden');
            
            // Заполняем отчет
            document.getElementById('final-code').innerText = userCode;
            document.getElementById('final-date').innerText = new Date().toLocaleString("ru-RU");
            document.getElementById('final-score').innerText = `${score} / ${quizData.length}`;
            
            // Темы
            if (wrongTopics.length > 0) {
                const list = document.getElementById('topic-list');
                document.getElementById('recommendation-block').classList.remove('hidden');
                // Убираем дубликаты и считаем
                const counts = {};
                wrongTopics.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
                Object.keys(counts).sort((a,b) => counts[b] - counts[a]).forEach(t => {
                    const li = document.createElement('li');
                    li.innerHTML = `<b>${t}</b> (${counts[t]} ош.)`;
                    list.appendChild(li);
                });
            }

            // Финальная отправка
            await fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'finish_test', code: userCode, score: score, wrongTopics: JSON.stringify(wrongTopics) })
            });
        }
    </script>
</body>
</html>
